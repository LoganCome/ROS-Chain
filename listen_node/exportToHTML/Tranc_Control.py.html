<html>
<head>
<title>Tranc_Control.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #067d17;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Tranc_Control.py</font>
</center></td></tr></table>
<pre><span class="s0">#! /usr/bin/env python</span>
<span class="s0"># coding: utf-8</span>

<span class="s2">import </span><span class="s1">rospy</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">from </span><span class="s1">move_base_msgs.msg </span><span class="s2">import </span><span class="s1">MoveBaseActionGoal</span>
<span class="s2">from </span><span class="s1">move_base_msgs.msg </span><span class="s2">import </span><span class="s1">MoveBaseActionResult</span>
<span class="s2">from </span><span class="s1">socket </span><span class="s2">import </span><span class="s1">*</span>
<span class="s2">import </span><span class="s1">random</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">threading</span>


<span class="s1">Robot_1_goal_topic_name = </span><span class="s3">'/robot_0/move_base/goal'</span>
<span class="s1">Robot_2_goal_topic_name = </span><span class="s3">'/robot_1/move_base/goal'</span>
<span class="s1">Robot_1_pos_topic_name = </span><span class="s3">'/robot_0/odom'</span>
<span class="s1">Robot_2_pos_topic_name = </span><span class="s3">'/robot_1/odom'</span>
<span class="s1">result = </span><span class="s3">'/robot_1/move_base/result'</span>
<span class="s1">URI = </span><span class="s3">'192.168.1.122'</span>
<span class="s1">port = </span><span class="s4">9093</span>
<span class="s1">port1 = </span><span class="s4">8850</span>
<span class="s1">port2 = </span><span class="s4">8851</span>
<span class="s1">Robot_enode = None</span>
<span class="s1">Tranc_enode = None</span>
<span class="s1">threads_pool = []</span>

<span class="s2">class </span><span class="s1">Udp_cli(object):</span>
    <span class="s2">def </span><span class="s1">__init__(self, ip, port):</span>
        <span class="s1">local_addr = (URI, port)</span>
        <span class="s1">self.ip = ip</span>
        <span class="s1">self.port = port</span>
        <span class="s1">self.udp_socket = socket(AF_INET, SOCK_DGRAM)</span>
        <span class="s1">self.udp_socket.bind(local_addr)</span>
        <span class="s1">self.dest_addr = (ip, port)</span>

    <span class="s2">def </span><span class="s1">send_msg(self, msg):</span>
        <span class="s1">send_data = msg</span>
        <span class="s1">self.udp_socket.sendto(send_data.encode(</span><span class="s3">'utf-8'</span><span class="s1">), self.dest_addr)</span>
        <span class="s1">self.udp_socket.close()</span>


<span class="s2">def </span><span class="s1">Random_org():</span>
    <span class="s1">a = random.uniform(</span><span class="s4">1629598000</span><span class="s1">,</span><span class="s4">1629598999</span><span class="s1">)</span>
    <span class="s1">b = random.uniform(</span><span class="s4">111111111</span><span class="s1">,</span><span class="s4">999999999</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">a,b</span>

<span class="s2">def </span><span class="s1">callback_action(msg):</span>
    <span class="s1">udp_cli = Udp_cli(ip=URI,port=port2)</span>
    <span class="s2">if not </span><span class="s1">isinstance(msg,MoveBaseActionResult):</span>
        <span class="s2">pass</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">status = msg.status.status</span>
        <span class="s2">if </span><span class="s1">status == </span><span class="s4">3</span><span class="s1">:</span>
            <span class="s1">msg = Robot_enode</span>
            <span class="s1">udp_cli.send_msg(msg)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">msg = -</span><span class="s4">1</span>
            <span class="s1">udp_cli.send_msg(msg)</span>

<span class="s2">def </span><span class="s1">Tranc_Implement(num,enode,x,y):</span>
    <span class="s1">a,b = Random_org()</span>
    <span class="s1">MoveBase = MoveBaseActionGoal()</span>
    <span class="s1">MoveBase.goal.target_pose.header.frame_id = </span><span class="s3">'map'</span>
    <span class="s1">MoveBase.goal.target_pose.header.seq = enode</span>
    <span class="s1">MoveBase.goal.target_pose.header.stamp.nsecs = b</span>
    <span class="s1">MoveBase.goal.target_pose.header.stamp.secs = a</span>
    <span class="s1">MoveBase.goal.target_pose.pose.orientation.x = </span><span class="s4">0.0</span>
    <span class="s1">MoveBase.goal.target_pose.pose.orientation.y = </span><span class="s4">0.0</span>
    <span class="s1">MoveBase.goal.target_pose.pose.orientation.z = </span><span class="s4">0.5</span>
    <span class="s1">MoveBase.goal.target_pose.pose.orientation.w = </span><span class="s4">0.5</span>
    <span class="s1">MoveBase.goal.target_pose.pose.position.x = float(x)</span>
    <span class="s1">MoveBase.goal.target_pose.pose.position.y = float(y)</span>
    <span class="s1">MoveBase.goal.target_pose.pose.position.z = </span><span class="s4">0.0</span>
    <span class="s1">MoveBase.goal_id.id = </span><span class="s3">''</span>
    <span class="s1">MoveBase.goal_id.stamp.secs = </span><span class="s4">0</span>
    <span class="s1">MoveBase.goal_id.stamp.nsecs = </span><span class="s4">0</span>
    <span class="s1">MoveBase.header.frame_id = </span><span class="s3">''</span>
    <span class="s1">MoveBase.header.seq = enode</span>
    <span class="s1">MoveBase.header.stamp.secs = a</span>
    <span class="s1">MoveBase.header.stamp.nsecs = b</span>
    <span class="s1">pub = rospy.Publisher(</span><span class="s3">&quot;/robot_&quot;</span><span class="s1">+str(num)+</span><span class="s3">&quot;/move_base/goal&quot;</span><span class="s1">,MoveBaseActionGoal,queue_size=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">pub.publish(MoveBase)</span>

<span class="s2">def </span><span class="s1">Trancisdone(enode):</span>
    <span class="s1">sub = rospy.Subscriber(</span><span class="s3">&quot;/robot_&quot;</span><span class="s1">+str(enode)+</span><span class="s3">&quot;/move_base/result&quot;</span><span class="s1">,MoveBaseActionResult,callback=callback_action)</span>

<span class="s2">def </span><span class="s1">MESG_Receive():</span>
    <span class="s1">Udp_Socket = socket(AF_INET, SOCK_DGRAM)</span>
    <span class="s1">Udp_Socket.bind((</span><span class="s3">&quot;192.168.1.118&quot;</span><span class="s1">, port1))</span>
    <span class="s2">while </span><span class="s1">True:</span>
        <span class="s0">#接受端口发送的数据</span>
        <span class="s1">Recv_Data = Udp_Socket.recvfrom(</span><span class="s4">1024</span><span class="s1">)</span>
        <span class="s0">#数据解码</span>
        <span class="s1">Recv_msg = Recv_Data[</span><span class="s4">0</span><span class="s1">].decode(</span><span class="s3">'utf-8'</span><span class="s1">)</span>
        <span class="s0">#数据分割处理</span>
        <span class="s1">Recv_msg = Recv_msg.split(</span><span class="s3">&quot;+&quot;</span><span class="s1">)</span>
        <span class="s2">global </span><span class="s1">Robot_enode</span>
        <span class="s2">global </span><span class="s1">Tranc_enode</span>
        <span class="s1">Robot_enode = int(Recv_msg[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">Tranc_enode = int(Recv_msg[</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">Tranc_x = int(Recv_msg[</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">Tranc_y = int(Recv_msg[</span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">Tranc_Implement(Robot_enode,Tranc_enode,Tranc_x,Tranc_y)</span>


<span class="s2">if </span><span class="s1">__name__ == </span><span class="s3">'__main__'</span><span class="s1">:</span>
    <span class="s1">t1 = threading.Thread(target=MESG_Receive)</span>
    <span class="s1">t2 = threading.Thread(target=Trancisdone,args=(Tranc_enode,))</span>
    <span class="s1">t1.start()</span>
    <span class="s1">t2.start()</span>
    <span class="s1">threads_pool.append(t1)</span>
    <span class="s1">threads_pool.append(t2)</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">threads_pool:</span>
        <span class="s1">i.join()</span>
    <span class="s2">print</span><span class="s1">(</span><span class="s3">&quot;Tranc info parse complete&quot;</span><span class="s1">)</span></pre>
</body>
</html>